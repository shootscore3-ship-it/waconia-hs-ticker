<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Waconia HS Rolling Board</title>
  <style>
    :root{
      --bg0:#070a10; --bg1:#0b0f14; --bg2:#111826;
      --card:#0f1624; --text:#f3f6ff; --muted:rgba(243,246,255,.72);
      --line:rgba(255,255,255,.10);
      --teal:#2dd4bf; --lime:#a3e635; --amber:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg0);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
    .app{height:100%;display:flex;flex-direction:column}

    .topbar{
      height:92px;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;
      background:linear-gradient(90deg,var(--bg1),var(--bg2));border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:14px}
    .pill{
      padding:10px 14px;border-radius:14px;background:rgba(45,212,191,.14);
      border:1px solid rgba(45,212,191,.33);font-weight:950;letter-spacing:.8px;text-transform:uppercase;
      font-size:16px;white-space:nowrap;
    }
    .title{font-size:26px;font-weight:1000}
    .subtitle{color:var(--muted);font-weight:850;font-size:14px;margin-top:3px}
    .clock{font-weight:950;font-size:26px;color:var(--muted);min-width:140px;text-align:right}

    .stage{
      flex:1;padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px;min-height:0;
    }
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);border-radius:18px;overflow:hidden;display:flex;flex-direction:column;min-height:0;
    }
    .panelHead{
      height:56px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--line);background:rgba(255,255,255,.03);
    }
    .panelHead .h{font-size:15px;font-weight:1000;letter-spacing:.8px;text-transform:uppercase}
    .panelHead .count{color:var(--muted);font-weight:900;font-size:13px}

    /* rolling pages */
    .pages{position:relative;flex:1;overflow:hidden}
    .page{
      position:absolute;inset:0;padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;
      opacity:0;transform:translateX(18px);transition:opacity .55s ease, transform .55s ease;
    }
    .page.active{opacity:1;transform:translateX(0)}
    .tile{
      background:rgba(15,22,36,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px;min-width:0;
    }
    .metaRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sport{display:flex;align-items:center;gap:10px;min-width:0}
    .sportIcon{
      width:30px;height:30px;border-radius:10px;display:grid;place-items:center;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);flex:0 0 auto;
    }
    .sportName{
      color:var(--muted);font-weight:950;font-size:13px;letter-spacing:.6px;text-transform:uppercase;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;
    }
    .tag{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);font-weight:950;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap}
    .final{color:var(--lime);border-color:rgba(163,230,53,.35);background:rgba(163,230,53,.10)}
    .live{color:var(--amber);border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.10)}
    .next{color:var(--teal);border-color:rgba(45,212,191,.35);background:rgba(45,212,191,.10)}

    .match{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;min-width:0}
    .team{display:flex;align-items:center;gap:10px;min-width:0}
    .team.right{justify-content:flex-end}
    .badge, .logo{
      width:46px;height:46px;border-radius:16px;display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);font-weight:1000;letter-spacing:.6px;flex:0 0 auto;
      background:rgba(255,255,255,.06);overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .teamName{font-weight:1000;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .vs{
      color:var(--muted);font-weight:950;font-size:13px;letter-spacing:.8px;text-transform:uppercase;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);
    }
    .bottomRow{display:flex;align-items:baseline;justify-content:space-between;gap:12px;min-width:0}
    .score{font-weight:1100;font-size:24px;white-space:nowrap}
    .detail{color:var(--muted);font-weight:850;font-size:13px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%}

    .footer{
      height:44px;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;
      color:var(--muted);border-top:1px solid var(--line);background:rgba(255,255,255,.02);
      font-weight:850;font-size:13px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="pill">Waconia HS</div>
        <div>
          <div class="title">Rolling Scores & Upcoming</div>
          <div class="subtitle" id="updated">Updated: —</div>
        </div>
      </div>
      <div class="clock" id="clock">--:--</div>
    </div>

    <div class="stage">
      <div class="panel">
        <div class="panelHead">
          <div class="h">Last 7 days</div>
          <div class="count" id="countFinals">0</div>
        </div>
        <div class="pages" id="finalPages"></div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div class="h">Next 5 days</div>
          <div class="count" id="countNext">0</div>
        </div>
        <div class="pages" id="nextPages"></div>
      </div>
    </div>

    <div class="footer">
      <div id="statusLine">Feed: OK</div>
      <div>Auto-rotates every 10s</div>
    </div>
  </div>

  <script>
    const FEED_URL = "https://calm-limit-4982.shootscore3.workers.dev";
    const LOGO_PROXY = "https://calm-limit-4982.shootscore3.workers.dev/logo?u=";

    const REFRESH_MS = 60_000;
    const ROTATE_MS = 10_000;     // rolling interval
    const PER_PAGE = 8;           // 2 columns x 4 rows

    const updatedEl = document.getElementById("updated");
    const clockEl = document.getElementById("clock");
    const statusLine = document.getElementById("statusLine");
    const finalPages = document.getElementById("finalPages");
    const nextPages = document.getElementById("nextPages");
    const countFinals = document.getElementById("countFinals");
    const countNext = document.getElementById("countNext");

    function pad(n){ return String(n).padStart(2,"0"); }
    function tickClock(){
      const d = new Date();
      const h12 = ((d.getHours()+11)%12)+1;
      const ampm = d.getHours()>=12 ? "PM":"AM";
      clockEl.textContent = `${h12}:${pad(d.getMinutes())} ${ampm}`;
    }

    function normStatus(s){
      s = (s || "next").toLowerCase().trim();
      if (s === "upcoming") return "next";
      if (s === "final" || s === "live" || s === "next") return s;
      return "next";
    }
    function tagHtml(status){
      if(status === "final") return '<span class="tag final">Final</span>';
      if(status === "live")  return '<span class="tag live">Live</span>';
      return '<span class="tag next">Next</span>';
    }

    // ---------- SVG sport decals (not emoji) ----------
    function sportSvg(type){
      // Simple clean icons (monochrome). Add more anytime.
      const common = `fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"`;
      const wrap = (inner)=>`<svg viewBox="0 0 24 24" width="18" height="18" ${common}>${inner}</svg>`;
      type = (type||"").toLowerCase();

      if(type.includes("basketball")) return wrap(`<circle cx="12" cy="12" r="9"/><path d="M3.5 12h17"/><path d="M12 3.5c3.5 3.8 3.5 13.2 0 17"/><path d="M12 3.5c-3.5 3.8-3.5 13.2 0 17"/>`);
      if(type.includes("football")) return wrap(`<path d="M7 10c4-5 10-5 10 2s-6 7-10 2 1-4 0-4Z"/><path d="M10 12h4"/><path d="M11 10.8v2.4"/><path d="M13 10.8v2.4"/>`);
      if(type.includes("hockey")) return wrap(`<path d="M7 4v9a4 4 0 0 0 8 0V4"/><path d="M6 20h10"/><path d="M10 20v-4"/><path d="M14 20v-4"/>`);
      if(type.includes("baseball") || type.includes("softball")) return wrap(`<circle cx="12" cy="12" r="9"/><path d="M8 7c2 2 2 8 0 10"/><path d="M16 7c-2 2-2 8 0 10"/>`);
      if(type.includes("soccer")) return wrap(`<circle cx="12" cy="12" r="9"/><path d="M12 7l3 2-1 3h-4l-1-3 3-2Z"/><path d="M9 12l-3 2"/><path d="M15 12l3 2"/><path d="M11 15l-1.5 3"/><path d="M13 15l1.5 3"/>`);
      if(type.includes("volleyball")) return wrap(`<circle cx="12" cy="12" r="9"/><path d="M12 3a9 9 0 0 1 0 18"/><path d="M12 3c-3 2-5 6-5 9s2 7 5 9"/><path d="M7 7a9 9 0 0 0 10 2"/>`);
      if(type.includes("wrestling")) return wrap(`<path d="M7 7a3 3 0 1 0 4 3"/><path d="M13 10a3 3 0 1 0 4 3"/><path d="M9 10l6 4"/><path d="M8 18h8"/>`);
      return wrap(`<path d="M4 18V6"/><path d="M20 18V6"/><path d="M4 12h16"/>`);
    }

    // ---------- auto badge fallback ----------
    function hashColor(str){
      let h = 0;
      for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
      const hue = h % 360;
      return `hsl(${hue} 70% 35%)`;
    }
    function initials(name){
      const parts = (name||"").replace(/[^A-Za-z0-9 ]/g,"").trim().split(/\s+/).filter(Boolean);
      if(!parts.length) return "HS";
      if(parts.length===1) return parts[0].slice(0,3).toUpperCase();
      return (parts[0][0] + (parts[1]?.[0]||"") + (parts[2]?.[0]||"")).toUpperCase();
    }

    // ---------- parse your current "text" lines ----------
    function parseLine(text){
      const parts = (text || "").split("•").map(x => x.trim()).filter(Boolean);
      const sport = parts.length ? parts[0] : "";
      const rest = parts.slice(1).join(" • ");

      let away="", home="", awayScore=null, homeScore=null, vsWord="vs", extra="";

      const atMatch = rest.match(/^(.*)\s@\s(.*)$/);
      const vsMatch = rest.match(/^(.*)\s(vs|vs\.|v\.|v)\s(.*)$/i);

      if(atMatch){ away = atMatch[1].trim(); home = atMatch[2].trim(); vsWord="@"; }
      else if(vsMatch){ away = vsMatch[1].trim(); home = vsMatch[3].trim(); vsWord="vs"; }
      else { extra = rest; }

      function splitNameScore(s){
        const m = s.match(/^(.*?)(?:\s+(\d+))?$/);
        return { name:(m?.[1]||"").trim(), score: m?.[2] ? Number(m[2]) : null };
      }
      if(away){ const a = splitNameScore(away); away = a.name; awayScore = a.score; }
      if(home){ const h = splitNameScore(home); home = h.name; homeScore = h.score; }

      const sportType = (sport.split(" ").slice(-1)[0] || sport).trim();
      return { sport, sportType, away, home, awayScore, homeScore, vsWord, extra };
    }

    function logoHtml(teamName, logoUrl){
      if(logoUrl){
        const proxied = LOGO_PROXY + encodeURIComponent(logoUrl);
        return `<div class="logo"><img src="${proxied}" alt="${teamName} logo" loading="lazy"></div>`;
      }
      const bg = hashColor(teamName || "team");
      const txt = initials(teamName);
      return `<div class="badge" style="background:${bg}">${txt}</div>`;
    }

    function tileHtml(item){
      const status = normStatus(item.status);
      // If Worker later sends structured fields, use them; otherwise parse "text"
      let sport = item.sport || "";
      let sportType = item.sportType || "";
      let away = item.away || "";
      let home = item.home || "";
      let awayScore = item.awayScore ?? null;
      let homeScore = item.homeScore ?? null;
      let vsWord = item.vsWord || "";
      let extra = item.detail || "";

      if(item.text){
        const p = parseLine(item.text);
        sport = sport || p.sport;
        sportType = sportType || p.sportType;
        away = away || p.away;
        home = home || p.home;
        awayScore = awayScore ?? p.awayScore;
        homeScore = homeScore ?? p.homeScore;
        vsWord = vsWord || p.vsWord;
        extra = extra || p.extra;
      }

      let score = "—";
      if(status === "final" || status === "live"){
        score = `${awayScore ?? "—"} - ${homeScore ?? "—"}`;
      }

      return `
        <div class="tile">
          <div class="metaRow">
            <div class="sport">
              <div class="sportIcon" style="color:rgba(243,246,255,.85)">${sportSvg(sportType || sport)}</div>
              <div class="sportName">${sport || "Game"}</div>
            </div>
            ${tagHtml(status)}
          </div>

          <div class="match">
            <div class="team">
              ${logoHtml(away || "Away", item.awayLogo)}
              <div class="teamName">${away || "—"}</div>
            </div>

            <div class="vs">${vsWord || "vs"}</div>

            <div class="team right">
              <div class="teamName">${home || "—"}</div>
              ${logoHtml(home || "Home", item.homeLogo)}
            </div>
          </div>

          <div class="bottomRow">
            <div class="score">${score}</div>
            <div class="detail">${extra || ""}</div>
          </div>
        </div>
      `;
    }

    function chunk(arr, size){
      const out = [];
      for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
      return out;
    }

    function buildPages(container, items){
      container.innerHTML = "";
      const pages = chunk(items, PER_PAGE);
      if(pages.length === 0){
        const p = document.createElement("div");
        p.className = "page active";
        p.innerHTML = `<div class="tile"><div class="metaRow"><div class="sport"><div class="sportIcon">${sportSvg("default")}</div><div class="sportName">No games</div></div></div></div>`;
        container.appendChild(p);
        return { pages:[p], index:0 };
      }

      const pageEls = pages.map((pageItems, idx)=>{
        const el = document.createElement("div");
        el.className = "page" + (idx===0 ? " active":"");
        el.innerHTML = pageItems.map(tileHtml).join("");
        container.appendChild(el);
        return el;
      });

      return { pages: pageEls, index: 0 };
    }

    let finalsState = { pages:[], index:0 };
    let nextState = { pages:[], index:0 };
    let rotTimer = null;

    function rotateOne(state){
      if(state.pages.length <= 1) return;
      const prev = state.pages[state.index];
      state.index = (state.index + 1) % state.pages.length;
      const next = state.pages[state.index];
      prev.classList.remove("active");
      next.classList.add("active");
    }

    function startRotate(){
      if(rotTimer) clearInterval(rotTimer);
      rotTimer = setInterval(()=>{
        rotateOne(finalsState);
        rotateOne(nextState);
      }, ROTATE_MS);
    }

    function renderAll(data){
      const items = (data.items || []).map(it => ({
        ...it,
        status: normStatus(it.status),
        text: it.text || ""
      }));

      const finals = items.filter(x => x.status === "final" || x.status === "live");
      const next = items.filter(x => x.status === "next");

      countFinals.textContent = `${finals.length} games`;
      countNext.textContent = `${next.length} games`;

      finalsState = buildPages(finalPages, finals);
      nextState = buildPages(nextPages, next);
      startRotate();

      if(data.updated){
        const d = new Date(data.updated);
        const h12 = ((d.getHours()+11)%12)+1;
        const ampm = d.getHours()>=12 ? "PM":"AM";
        updatedEl.textContent = `Updated: ${h12}:${pad(d.getMinutes())} ${ampm}`;
      } else updatedEl.textContent = "Updated: —";
    }

    async function load(){
      try{
        statusLine.textContent = "Feed: loading…";
        const res = await fetch(FEED_URL + "?v=" + Date.now(), { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        renderAll(data);
        statusLine.textContent = "Feed: OK";
      }catch(e){
        statusLine.textContent = "Feed: error";
        console.error(e);
      }
    }

    tickClock();
    setInterval(tickClock, 1000);
    load();
    setInterval(load, REFRESH_MS);
  </script>
</body>
</html>
